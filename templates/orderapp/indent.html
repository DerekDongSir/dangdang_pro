<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>当当网</title>
    <script src="/static/jquery/jquery.1.8.3.min.js"></script>
    <link href="/static/css/shopping_cart_new.css" rel="stylesheet" type="text/css">
	<link href="/static/css/footer_150526.css" rel="stylesheet" type="text/css" />
    <script>
        function logout() {
            $.ajax({
                type:'GET',
                url:"{% url 'userapp:logout' %}",
                success:function (res) {
                    if(res === 'ok'){
                        document.getElementById('nickname').innerHTML =" <span class=\"hi hi_none\">欢迎光临当当，请</span><a href=\"{% url 'userapp:login' %}?current_id=1\" class=\"login_link\">登录</a><a href=\"{% url 'userapp:register' %}?current_id=1\">免费注册</a>";
                    }
                }
            })
        }

        function move_to_cart(book_id,price){
            $.ajax({
                type:"GET",
                url:"{% url 'orderapp:remove_from_cart' %}",
                data:"book_id="+book_id,
                success:function (res) {
                    var temp = ($("#total_cost1").text() - price).toFixed(1);
                    {#更新总金额#}
                    $("#total_cost1").text(temp);
                    $("#total_cost2").text('￥'+temp);
                    $("#total_cost3").text('￥'+temp);
                    {#将本行移除#}
                    $("#list"+book_id).remove();
                }
            });
        }
        var name_flag = false;var address_flag = false; var zip_flag = false; var phone_flag = false;
        function check_name() {
            if(!$('#txt_name').val())
            {   $("#cue_name").text('姓名不能为空'); $("#cue_name").css('color','red');}
        else{ name_flag = true; $("#cue_name").html("<img src=\"/static/pics/right_3.jpg\" width=\"20px\">");     }}
        function check_address() {
             if(!$('#txt_address').val())
            {   $("#cue_address").text('地址不能为空'); $("#cue_address").css('color','red');}
        else{address_flag = true;  $("#cue_address").html("<img src=\"/static/pics/right_3.jpg\" width=\"20px\">")     }}
        function check_zip() {
            if(!$('#txt_zipcode').val())
            {   $("#cue_zip_code").text('邮编不能为空'); $("#cue_zip_code").css('color','red');}
        else{  zip_flag = true; $("#cue_zip_code").html("<img src=\"/static/pics/right_3.jpg\" width=\"20px\">")     }}
        function check_phone() {
             if(!$('#txt_phone').val())
            {   $("#cue_phone").text('手机号码不能为空'); $("#cue_phone").css('color','red');}
        else{  phone_flag = true; $("#cue_phone").html("<img src=\"/static/pics/right_3.jpg\" width=\"20px\">")     }}
         function submit_order(){
                var choice = $("#choice").val();
                if(choice === 'new'){
                    if(name_flag && address_flag && zip_flag && phone_flag)
                    {
                        $.ajax({
                            type:'GET',
                            url:"{% url 'orderapp:check_address' %}",
                            data:'address='+$('#txt_address').val(),
                            success:function (res) {
                                if(res === 'ok'){
                                $("#my_form").submit();
                                }else{
                                    alert('您输入的地址已经存在，请选择一个新的地址')
                                }
                            }
                        });
                    }
                    else{  alert('请确保输入的信息有效'); }
                }else{
                    location.href ="{% url 'orderapp:location_info' %}?delivery_id="+choice;
                }   }

            eval("(" + xhr.responseText + ")");
        function fill_form(delivery_id) {
            if(delivery_id === 'new'){
                {#将输入框中的值置空，同时移除disabled属性#}
                $('#txt_name').val(null);$('#txt_name').removeAttr('disabled');
                 $("#cue_name").html("请填写收货人姓名");
                $('#txt_address').val(null);$('#txt_address').removeAttr('disabled');
                 $("#cue_address").html("请填写收货地址");
                $("#txt_zipcode").val(null);$('#txt_zipcode').removeAttr('disabled');
                 $("#cue_zip_code").html("请填写邮编");
                $("#txt_phone").val(null);$('#txt_phone').removeAttr('disabled');
                 $("#cue_phone").html("请填写手机号");
                {#$("#txt_telephone").val(null);$('#txt_telephone').removeAttr('disabled');#}
            }else{
                $.ajax({
                    type:'GET',
                    url:"{% url 'orderapp:get_delivery_info' %}",
                    data:'delivery_id='+delivery_id,
                    success:function (res) {
                        $('#txt_name').val(res['name']);$('#txt_name').attr('disabled', 'disabled');
                        $("#cue_name").html("<img src=\"/static/pics/right_3.jpg\" width=\"20px\">");
                        $('#txt_address').val(res['address']);$('#txt_address').attr('disabled', 'disabled');
                        $("#cue_address").html("<img src=\"/static/pics/right_3.jpg\" width=\"20px\">");
                        $("#txt_zipcode").val(res['zip_code']);$('#txt_zipcode').attr('disabled', 'disabled');
                        $("#cue_zip_code").html("<img src=\"/static/pics/right_3.jpg\" width=\"20px\">");
                        $("#txt_phone").val(res['phone']);$('#txt_phone').attr('disabled', 'disabled');
                        $("#cue_phone").html("<img src=\"/static/pics/right_3.jpg\" width=\"20px\">");
                        {#$("#txt_telephone").val(res['telephone']);#}
                        {#$('#txt_telephone').attr('disabled', 'disabled');#}
                    }
                });
            }
        }


    </script>
</head>
<body style="padding-bottom:82px">
<link href="/static/css/header_960_150611.css" rel="stylesheet" type="text/css">
<script src="/static/js/pagetop2015_0827.js" charset="gb2312" type="text/javascript"></script>
<div id="hd">
<div id="tools">
<div class="tools">
    <div class="ddnewhead_operate">
        <div class="ddnewhead_welcome" >
            <span id="nickname">
                 <span class="hi hi_none">欢迎<span> </span>{{ request.session.username }}！</span>
                   <a href="javascript:void(0)" onclick="logout()">【退出登录】</a>
            </span>
        </div>
        <div class="new_head_znx" id="znx_content" style="display:none;"></div>
    </div>
</div>
</div>
<div id="header_end"></div>
<!--CreateDate  2016-09-28 11:30:01--></div>
<form action="#" id="bootpagetopSearch" name="bootpagetopSearch" method="GET"></form>
<script type="text/javascript" src="http://orderb.dangdang.com/queryunpaid?callback=Unpaid_Data"></script>
		<div class="shoppingcart_wrapper" id="ad_cpt_11850">
            <div>
            <a href="javascript:void(0)" target="_blank" rel="nofollow"><img src="http://img62.ddimg.cn/2017/1/11/2017011111344969879.jpg"></a>
            </div>
        </div>
<div class="logo_line">
    <div class="w960">
        <div class="shopping_procedure01 shopping_procedure">
            <span>我的购物车</span><span class="current">填写订单</span><span>完成订单</span>
        </div>
        <div class="logo">
            <a href="javascript:void(0)"><img src="/static/images/bz_logo_car.jpg" alt=""></a>
        </div>
    </div>
</div>
<div class="indent_con">
	<div class="shdz">
    	<h3>收货相关信息</h3>
    <form id='my_form' action="{% url 'orderapp:location_info' %}" method="post">
            {% csrf_token %}
        <ul class="shdz_con">
            <p>▪ 收货地址</p>
            <li>
                <select name="choice" id="choice" onchange="fill_form(this.options[this.selectedIndex].value)">
                    <option value="new">新建</option>
{#                    <option value="1">1111</option>#}
                    {% for location in locations %}
                        <option value="{{ location.id }}">{{ location.address }}</option>
                    {% endfor %}
                </select>
            </li>
        	<li>
                <label><strong>*</strong>收&nbsp;&nbsp;货&nbsp;&nbsp;人：</label>
                <input  type="text" id='txt_name' name="receiver_name" onblur="check_name()" >
                <span id="cue_name" class="hint new_tip" style="display: block;" >请填写收货人姓名</span>

            </li>
            <li style="display: none">
                <label><strong>*</strong>收货地区：</label> 
                <select id="country_id" name="country_id" onfocus="check_focus('spn_country_province_city');" onblur="check_country_province_city();" onchange="set_province(this.options[this.selectedIndex].value);" style="display: block;"><option value="9000">中国</option><option value="16767">阿尔及利亚</option><option value="10707">巴西</option><option value="16868">白俄罗斯</option><option value="16969">保加利亚</option><option value="13535">比利时</option><option value="15656">波多黎各</option><option value="14949">波兰</option><option value="17272">玻利维亚</option><option value="14444">丹麦</option><option value="10505">德国</option><option value="15353">俄罗斯</option><option value="10404">法国</option><option value="12222">菲律宾</option><option value="12323">芬兰</option><option value="17474">古巴</option><option value="12424">关岛</option><option value="10808">韩国</option><option value="12121">荷兰</option><option value="11010">加拿大</option><option value="15151">柬埔寨</option><option value="11111">捷克</option><option value="17373">喀麦隆</option><option value="14848">科威特</option><option value="15858">老挝</option><option value="16262">黎嫩</option><option value="15959">列支敦士登</option><option value="16060">卢森堡</option><option value="17070">卢旺达</option><option value="13030">罗马尼亚</option><option value="15555">马尔代夫</option><option value="13636">马来西亚</option><option value="10101">美国</option><option value="14545">蒙古</option><option value="17171">孟加拉</option><option value="11818">秘鲁</option><option value="11212">墨西哥</option><option value="13232">南非</option><option value="10303">日本</option><option value="11414">瑞典</option><option value="13737">瑞士</option><option value="13333">斯里兰卡</option><option value="13434">泰国</option><option value="11515">西班牙</option><option value="14343">希腊</option><option value="13131">新加坡</option><option value="12727">新西兰</option><option value="14141">匈牙利</option><option value="11616">意大利</option><option value="10606">印度</option><option value="10202">英国</option><option value="14242">越南<option value="19999">其他国家或地区</option></select>
                <select id="province_id" name="province_id" onfocus="check_focus('spn_country_province_city');" onblur="check_country_province_city();" onchange="set_city(this.options[this.selectedIndex].value);" style="display: block;"><option value="0">--请选择--</option><option value="111">北京</option><option value="112">天津</option><option value="113">河北</option><option value="114">山西</option><option value="115">内蒙古</option><option value="121">辽宁</option><option value="122">吉林</option><option value="123">黑龙江</option><option value="131">上海</option><option value="132">江苏</option><option value="133">浙江</option><option value="134">安徽</option><option value="135">福建</option><option value="136">江西</option><option value="137">山东</option><option value="141">河南</option><option value="142">湖北</option><option value="143">湖南</option><option value="144">广东</option><option value="145">广西</option><option value="146">海南</option><option value="150">重庆</option><option value="151">四川</option><option value="152">贵州</option><option value="153">云南</option><option value="154">西藏</option><option value="161">陕西</option><option value="162">甘肃</option><option value="163">青海</option><option value="164">宁夏</option><option value="165">新疆</option><option value="171">台湾</option><option value="172">香港</option><option value="173">澳门</option><option value="33">其他省份</option></select>
                <select id="opt_city" name="city"><option value=0>请选择</option><option value="Nanjing">南京市</option></select>
                <select id="opt_town" name="town" ><option value=0>请选择</option>
                    <option value="Xuanwu">玄武区</option></select>
                <select id="opt_quarter" name="quarter" ><option value="0">请选择</option>
                    <option value="Xiaolingwei">孝陵卫</option></select>
            </li>
            <li><label><strong>*</strong>详细地址：</label>
                <input type="text" id="txt_address" name="address" onblur="check_address()">
                <span id="cue_address" class="hint new_tip" style="display: block;">请填写收货地址</span>
            </li>
            <li><label><strong>*</strong>邮政编码：</label>
                <input type="text" id='txt_zipcode' name="zip_code"  maxlength="6" onblur="check_zip()">
                <span id="cue_zip_code" class="hint new_tip" style="display: block;">请填写邮编</span>

            </li>
            <li><label><strong>*</strong>手&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;机：</label>
                <input type="text" id='txt_phone' name="phone" onblur="check_phone()">
                <span id="cue_phone" class="hint new_tip" style="display: block;">请填写手机号</span>
{#                <label>或&nbsp;&nbsp;固定电话</label>#}
{#                <input type="text" id='txt_telephone' name="telephone"  >#}
            </li>
        </ul>
        </form>
        <div class="balance">
            <p>商品金额：¥<span id="total_cost1">{{ total_cost }}</span></p>
            <p class="yfze">应付总额（含运费）：<em id="total_cost2">¥{{ total_cost }}</em></p>

            <p><a href="javascript:void(0)" onclick="submit_order()">提交订单</a></p>
        </div>
    </div>
    <div class="shdz">
    	<h3>订单1（百知网配送）</h3>
        <table width="100%" border="0" cellpadding="0" cellspacing="0">
            <tbody>
            <tr style="height:30px; line-height:30px;">
                <th width="34%">商品名称</th>
                <th width="11%">所在仓库</th>
                <th width="13%">百知价</th>
                <th width="11%">促销价</th>
                <th width="9%">数量</th>
                <th width="11%">小计</th>
                <th width="11%">操作</th>
            </tr>
            {% for item in items %}
            <tr id="list{{ item.book.id }}">
                <td align="center">{{ item.book.book_name }}</td>
                <td align="center">人民出版</td>
                <td align="center">¥{{ item.price }}（ {% widthratio  item.book.dangdang_price item.book.marketing_price  100 %}折）</td>
                <td align="center">--</td>
                <td align="center">{{ item.book_num }}</td>
                <td align="center">¥{{ item.price }}</td>
                <td align="center">
                    <a onclick="move_to_cart({{ item.book.id }},{{ item.price }})" href="javascript:void(0)" >放回购物车</a>
                </td>
            </tr>
             {% endfor %}
             <tr>
                <td colspan="2"><input type="checkbox" >此订单作为礼品赠送他人</td>
                <td colspan="2"><strong>运费：</strong>当确认送货方式后显示</td>
                <td class="table_zj" colspan="3"><strong>小计总额：</strong><em id="total_cost3">¥{{ total_cost }}</em></td>
            </tr>
        </tbody>
    </table>
</div>
</div>
{#----------------------------------------------------------------------------------------------------------------------#}
<div id="footer">
<div class="footer">
	<div class="footer_nav_box">
		<div class="footer_copyright">
            <span>Copyright (C) 当当网 2004-2014, All Rights Reserved</span>
            <a href="http://www.hd315.gov.cn/beian/view.asp?bianhao=010202001051000098" target="_blank"
               class="footer_img" rel="nofollow">
                <img src="http://img4.dangdang.com/bottom/validate.gif">
            </a>
            <span>
                <a href="http://www.miibeian.gov.cn/" target="_blank" rel="nofollow">京ICP证041189号</a>
            </span>
            <span>出版物经营许可证&nbsp;新出发京批字第直0673号</span>
        </div>
	</div>
</div>
</div>
    <div class="foot_tip_ad">广告</div>
    <style>
        .foot_tip_ad { width:40px; height:40px; font:12px/40px "simsun"; text-align:center; color:#fff; background-color:#474747; position:fixed; right:0; bottom:10px;_position:absolute; _bottom:auto;_top:expression(eval(document.documentElement.scrollTop+document.documentElement.clientHeight-this.offsetHeight-(parseInt(this.currentStyle.marginTop,10)||0)-(parseInt(this.currentStyle.marginBottom,10)||0)));}
    </style>
</body>
</html>
